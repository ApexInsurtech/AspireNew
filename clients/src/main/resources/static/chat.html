<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Apex Labs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- App favicon -->
  <link rel="shortcut icon" href="assets/images/favicon.ico">
  <!-- C3 charts css -->
  <link href="/plugins/c3/c3.min.css" rel="stylesheet" type="text/css"  />
  <!-- App css -->
  <link href="/assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
  <link href="/assets/css/icons.css" rel="stylesheet" type="text/css" />
  <link href="/assets/css/metismenu.min.css" rel="stylesheet" type="text/css" />
  <link href="assets/css/style_light.css" rel="stylesheet" type="text/css" />
  <link href="/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css" rel="stylesheet">
  <script src="/assets/js/modernizr.min.js"></script>
</head>
<body>
<!-- Begin page -->
<div id="wrapper">
  <!-- Top Bar Start -->
  <div class="topbar">
    <!-- LOGO -->
    <div class="topbar-left">
      <a href="index.html" class="logo">
        <span>
          <img src="assets/images/logo.png" alt="" height="25">
        </span>
        <i>
          <img src="assets/images/logo_sm.png" alt="" height="28">
        </i>
      </a>
    </div>
    <nav class="navbar-custom">
      <ul class="list-inline float-right mb-0">
        <li class="list-inline-item notification-list">
          <a class="nav-link dropdown-toggle arrow-none waves-light waves-effect" href="/chat.html" role="button" aria-haspopup="false" aria-expanded="false"><i class="dripicons-message noti-icon"></i></a>
        </li>
        <li class="list-inline-item dropdown notification-list">
          <a class="nav-link dropdown-toggle waves-effect waves-light nav-user" data-toggle="dropdown" href="#" role="button"
             aria-haspopup="false" aria-expanded="false">
            <img src="assets/images/users/avatar-1.jpg" alt="user" class="rounded-circle">
          </a>
          <div class="dropdown-menu dropdown-menu-right profile-dropdown " aria-labelledby="Preview">
            <div class="dropdown-item noti-title">
              <h5 class="text-overflow"><small>Welcome User!</small> </h5>
            </div>
          </div>
        </li>
      </ul>
      <ul class="list-inline menu-left mb-0">
        <li class="float-left">
          <button class="button-menu-mobile open-left waves-light waves-effect">
            <i class="dripicons-menu"></i>
          </button>
        </li>
      </ul>
    </nav>
  </div>
  <div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
      <div id="sidebar-menu">
        <ul class="metismenu" id="side-menu">
          <li class="menu-title">Navigation</li>
          <li>
            <a href="index.html">
              <i class="fi-air-play"></i><span> Dashboard </span>
            </a>
          </li>
          <li>
            <a href="proposals.html"><i class="fi-briefcase"></i> <span> Proposals </span></a>
          </li>
          <li>
            <a href="#"><i class="fi-briefcase"></i> <span> Policies </span></a>
          </li>
          <li>
            <a href="#"><i class="fi-briefcase"></i> <span> Claims </span></a>
          </li>
          <li>
            <a href="#"><i class="fi-briefcase"></i> <span> Accounting </span></a>
          </li>
          <li>
            <a href="chat.html"><i class="dripicons-message"></i> <span> Chat </span></a>
          </li>
        </ul>
      </div>
      <div class="clearfix"></div>
    </div>
  </div>
  <div class="content-page">
    <!-- Start content -->
    <div class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
            <div class="page-title-box">
              <div class="float-left"><h4 class="page-title">Chat</h4></div>
              <div class="float-right">
                <button class="btn btn-primary" id="btnAddChat"><i class="fa fa-plus"></i> New Chat</button>
              </div>
              <div class="clearfix"></div>
            </div>
          </div>
        </div>
        <!-- end row -->
        <div class="row">
          <div class="col-sm-4">
            <div class="card">
              <div class="card-body">
                <h4 class="card-title">My Chats</h4>
              </div>
              <ul id="chats" class="list-group list-group-flush">
                <li class="list-group-item">No Chats</li>
              </ul>
            </div>
          </div><!-- end col -->
          <div class="col-sm-8">
            <div class="card">
              <div class="card-title pt-2 mb-1 pr-2">
                <div class="float-right">
                  <button id="add_member" class="btn btn-rounded btn-primary dropdown-toggle" disabled type="button" data-toggle="dropdown">Add Member
                    <span class="caret"></span>
                  </button>
                  <ul id="add-member-list" class="dropdown-menu"></ul>
                </div>
              </div>
              <div id="selected_chat" class="card-body" style="height: 500px; overflow-y: auto;">
                <h6>Select a Chat</h6>
              </div>
              <div class="card-body">
                <div class="form-group col-12">
                  <input type="text" class="form-control" name="inpMessage" placeholder="Enter Message" disabled>
                </div>
              </div>
            </div>
          </div><!-- end col -->
        </div>
        <!--- end row -->
      </div> <!-- container -->
    </div> <!-- content -->
    <!-- Button trigger modal -->    
    <!-- Modal -->
    <footer class="footer text-right">
      2019 &copy; Apex Labs
    </footer>
  </div>
</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/popper.min.js"></script><!-- Popper for Bootstrap -->
<script src="/assets/js/bootstrap.min.js"></script>
<script src="/assets/js/metisMenu.min.js"></script>
<script src="/assets/js/waves.js"></script>
<script src="/assets/js/jquery.slimscroll.js"></script>
<script src="/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script>
<!-- Counter js  -->
<script src="/plugins/waypoints/jquery.waypoints.min.js"></script>
<script src="/plugins/counterup/jquery.counterup.min.js"></script>
<!--C3 Chart-->
<script type="text/javascript" src="/plugins/d3/d3.min.js"></script>
<script type="text/javascript" src="/plugins/c3/c3.min.js"></script>
<!--Echart Chart-->
<script src="/plugins/echart/echarts-all.js"></script>
<!-- Dashboard init -->
<script src="/assets/pages/jquery.dashboard.js"></script>
<!-- App js -->
<script src="/assets/js/jquery.core.js"></script>
<script src="/assets/js/jquery.app.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js" integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ=" crossorigin="anonymous"></script>
<script>
  $(function(){
    $("input[name=inpMessage]").attr("disabled", "true");
    $("#add_member").attr("disabled", "true");
    $("#btnAddChat").on("click", function(){
      $.ajax({
        "url": "/chat/make-group",
        "method": "post",
        "success": function(response){
          $.ajax({
            "url": "/chat/list",
            "method": "post",
            "success": function(response){
              let chats = "";
              for(let chat of response){
                let dt = moment(chat['time']).format("YYYY-MM-DD HH:mm:ss Z");
                chats += "<li class=\"list-group-item chat\" style=\"cursor: pointer;\" data-allow-add=\""+chat["allow_add"]+"\" data-chat-id=\""+chat["chat_id"]+"\">"+chat["last_message"]+" by "+chat["by"]+"<br><small>"+dt+"</small></li>";
              }
              $("#chats").html("");
              $("#chats").html(chats);
            }
          });
        }
      });
    });
    $.ajax({
      "url": "/chat/list",
      "method": "post",
      "success": function(response){
        let chats = "";
        for(let chat of response){
          let dt = moment(chat['time']).format("YYYY-MM-DD HH:mm:ss Z");
          chats += "<li class=\"list-group-item chat\" style=\"cursor: pointer;\" data-allow-add=\""+chat["allow_add"]+"\" data-chat-id=\""+chat["chat_id"]+"\">"+chat["last_message"]+" by "+chat["by"]+"<br><small>"+dt+"</small></li>";
        }
        $("#chats").html("");
        $("#chats").html(chats);
      }
    });
    $("input[name=inpMessage]").on("keyup", async function(e){
      if(e.keyCode == 13){
        $("input[name=inpMessage]").attr("disabled", "true");
        let message = $(this).val();
        let chat_id = $(this).data("group_id")
        await $.ajax({
          url: "/chat/add-message",
          method: "post",
          data: JSON.stringify({"group_id": chat_id, "message": message }),
          dataType: "json",
          contentType: 'application/json',
          processData: false,
        });
        let reponse = await $.ajax({
          url: "/chat/list-messages",
          method: "post",
          data: JSON.stringify({"group_id": chat_id }),
          dataType: "json",
          contentType: 'application/json',
          processData: false,
        });
        let messages = "";
        for(let msg of response){
          if(msg["message"] == "") continue;
          let dt = moment(msg['time']).format("YYYY-MM-DD HH:mm:ss Z");
          messages += "<div style=\"border: 1px solid rgba(0,0,0,0.2); margin-top: 5px; padding: 5px 10px; border-radius: 3px; width: 50%; "+ (msg["party"] == "Me" ? "margin-left: 50%;" : "margin-right: 50%;") +"\" class=\""+ (msg["party"] == "Me" ? "float-right" : "float-left") +"\"><span>"+msg["message"]+"</span><br><small>"+msg["party"]+" @ "+dt+"</small></div>";
        }
        messages +="<div class=\"clearfix\"></div>";
        $("#selected_chat").html("");
        $("#selected_chat").html(messages);
        $("input[name=inpMessage]").data("group_id", chat_id);
        $("input[name=inpMessage]").val("");
        $("input[name=inpMessage]").removeAttr("disabled");
      }
    });
    $("body").on("click", ".add-member",async function(){
      let member = $(this).data("party");
      let group_id = $("input[name=inpMessage]").data("group_id");
      await $.ajax({
        "url": "/chat/add-member",
        method: "post",
        data: JSON.stringify({"group_id": group_id, "party": member }),
        dataType: "json",
        contentType: 'application/json',
        processData: false,
      });
      let reponse = await $.ajax({
        url: "/chat/list-messages",
        method: "post",
        data: JSON.stringify({"group_id": chat_id }),
        dataType: "json",
        contentType: 'application/json',
        processData: false,
      });
      let messages = "";
      for(let msg of response){
        if(msg["message"] == "") continue;
        let dt = moment(msg['time']).format("YYYY-MM-DD HH:mm:ss Z");
        messages += "<div style=\"border: 1px solid rgba(0,0,0,0.2); margin-top: 5px; padding: 5px 10px; border-radius: 3px; width: 50%; "+ (msg["party"] == "Me" ? "margin-left: 50%;" : "margin-right: 50%;") +"\" class=\""+ (msg["party"] == "Me" ? "float-right" : "float-left") +"\"><span>"+msg["message"]+"</span><br><small>"+msg["party"]+" @ "+dt+"</small></div>";
      }
      messages +="<div class=\"clearfix\"></div>";
      $("#selected_chat").html("");
      $("#selected_chat").html(messages);
      $("input[name=inpMessage]").data("group_id", chat_id);
      let clist = await $.ajax({
        "url": "/chat/list",
        "method": "post",
      });
      let chats = "";
      for(let chat of clist){
        let dt = moment(chat['time']).format("YYYY-MM-DD HH:mm:ss Z");
        chats += "<li class=\"list-group-item chat\" style=\"cursor: pointer;\" data-allow-add=\""+chat["allow_add"]+"\" data-chat-id=\""+chat["chat_id"]+"\">"+chat["last_message"]+" by "+chat["by"]+"<br><small>"+dt+"</small></li>";
      }
      $("#chats").html("");
      $("#chats").html(chats);
    });
    $("body").on("click", ".chat", async function(){
      let chat_id = $(this).data("chat-id");
      let allow_add = $(this).data("allow-add");
      let response = await $.ajax({
        url: "/chat/list-messages",
        method: "post",
        data: JSON.stringify({"group_id": chat_id }),
        dataType: "json",
        contentType: 'application/json',
        processData: false,
      });
      if(!allow_add){
        $("#add_member").attr("disabled", "disabled");
      }else{
        $("#add_member").removeAttr("disabled");
      }
      let messages = "";
      for(let msg of response){
        if(msg["message"] == "") continue;
        let dt = moment(msg['time']).format("YYYY-MM-DD HH:mm:ss Z");
        messages += "<div style=\"border: 1px solid rgba(0,0,0,0.2); margin-top: 5px; padding: 5px 10px; border-radius: 3px; width: 50%; "+ (msg["party"] == "Me" ? "margin-left: 50%;" : "margin-right: 50%;") +"\" class=\""+ (msg["party"] == "Me" ? "float-right" : "float-left") +"\"><span>"+msg["message"]+"</span><br><small>"+msg["party"]+" @ "+dt+"</small></div>";
      }
      messages +="<div class=\"clearfix\"></div>";
      $("#selected_chat").html("");
      $("#selected_chat").html(messages);
      $("input[name=inpMessage]").data("group_id", chat_id);
      $("input[name=inpMessage]").removeAttr("disabled");
      let parties = await $.ajax({
        url: "/chat/available",
        method: "post"
      });
      $("#add-member-list").html("");
      let partyHtml = "";
      for(let party of parties){
        partyHtml += "<li><a class=\"dropdown-item add-member\" data-party=\""+party+"\">"+party+"</a></li>"
      }
      $("#add-member-list").html(partyHtml);
    });
  });
</script>
</body>
</html>